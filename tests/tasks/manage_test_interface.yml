# SPDX-License-Identifier: BSD-3-Clause
---
- name: Ensure state in ["present", "absent"]
  fail:
    msg: "state needs to be present or absent, not '{{ state }}'"
  when: state not in ["present", "absent"]

- name: Ensure type in ["dummy", "tap", "veth"]
  fail:
    msg: "type needs to be dummy, tap or veth, not '{{ type }}'"
  when: type not in ["dummy", "tap", "veth"]

- name: Include the task 'show_interfaces.yml'
  include_tasks: show_interfaces.yml

- name: Install iproute
  package:
    name: iproute
    state: present
    use: "{{ (__network_is_ostree | d(false)) |
      ternary('ansible.posix.rhel_rpm_ostree', omit) }}"
  register: __install_status
  until: __install_status is success
  retries: 6
  delay: 10

# veth
- name: Create veth interface {{ lsr_interface | d(interface) }}
  command: "{{ item }}"
  with_items:
    - ip link add {{ lsr_interface | d(interface) }} type veth peer name peer{{ lsr_interface | d(interface) }}
    - ip link set peer{{ lsr_interface | d(interface) }} up
    - ip link set {{ lsr_interface | d(interface) }} up
  when:
    - ansible_connection != 'buildah'
    - type == 'veth'
    - state == 'present'
    - lsr_interface | d(interface) not in current_interfaces
  changed_when: false

- name: Set up veth as managed by NetworkManager
  command: nmcli d set {{ lsr_interface | d(interface) }} managed true
  # The variable for `network_provider` is not exists yet,
  # just ignore error for initscripts
  ignore_errors: true  # noqa ignore-errors
  when:
    - ansible_connection != 'buildah'
    - type == 'veth'
    - state == 'present'
  changed_when: false

- name: Delete veth interface {{ lsr_interface | d(interface) }}
  command: ip link del {{ lsr_interface | d(interface) }} type veth
  when:
    - ansible_connection != 'buildah'
    - type == 'veth'
    - state == 'absent'
    - lsr_interface | d(interface) in current_interfaces
  changed_when: false

# dummy
- name: Create dummy interface {{ lsr_interface | d(interface) }}
  command: ip link add "{{ lsr_interface | d(interface) }}" type dummy
  when:
    - ansible_connection != 'buildah'
    - type == 'dummy'
    - state == 'present'
    - lsr_interface | d(interface) not in current_interfaces
  changed_when: false

- name: Delete dummy interface {{ lsr_interface | d(interface) }}
  command: ip link del "{{ lsr_interface | d(interface) }}" type dummy
  when:
    - ansible_connection != 'buildah'
    - type == 'dummy'
    - state == 'absent'
    - lsr_interface | d(interface) in current_interfaces
  changed_when: false

# tap
- name: Create tap interface {{ lsr_interface | d(interface) }}
  command: ip tuntap add dev {{ lsr_interface | d(interface) }} mode tap
  when:
    - ansible_connection != 'buildah'
    - type == 'tap'
    - state == 'present'
    - lsr_interface | d(interface) not in current_interfaces
  changed_when: false

- name: Delete tap interface {{ lsr_interface | d(interface) }}
  command: ip tuntap del dev {{ lsr_interface | d(interface) }} mode tap
  when:
    - ansible_connection != 'buildah'
    - type == 'tap'
    - state == 'absent'
    - lsr_interface | d(interface) in current_interfaces
  changed_when: false
