# SPDX-License-Identifier: BSD-3-Clause
---
- name: Play for testing auto_gateway setting
  hosts: all
  vars:
    type: veth
    interface: veth0
  tasks:
    - name: Test setting auto_gateway to true
      include_tasks: tasks/run_test.yml
      vars:
        lsr_description: Test auto_gateway setting to true
        lsr_setup:
          - what: tasks/manage_test_interface.yml
            state: present
          - tasks/assert_device_present.yml
        lsr_test:
          - network_connections:
              - name: "{{ interface }}"
                type: ethernet
                state: up
                ip:
                  auto_gateway: true
                  dhcp4: false
                  auto6: false
                  address:
                    - "2001:db8::2/64"
                    - "203.0.113.2/24"
                  gateway6: "2001:db8::1"
                  gateway4: "203.0.113.1"
                  # change the default route metric to higher value so that it will
                  # not take precedence over other routes or not ignore other
                  # routes
                  route_metric4: 65535
        lsr_assert:
          - tasks/assert_device_present.yml
          - what: tasks/assert_profile_present.yml
            profile: "{{ interface }}"
          - what: tasks/assert_command_output.yml
            condition: "{{ __network_is_booted }}"
            lsr_command: ip route
            lsr_stdout: default via 203.0.113.1 dev {{ interface }}
          - what: tasks/assert_command_output.yml
            condition: "{{ __network_is_booted and network_provider == 'nm' }}"
            lsr_command: ip -6 route
            lsr_stdout: default via 2001:db8::1 dev {{ interface }}
        lsr_cleanup:
          - what: tasks/down_profile+delete_interface.yml
            condition: "{{ __network_is_booted }}"
            profile: "{{ interface }}"
            lsr_persistent_state: absent
          - what: tasks/manage_test_interface.yml
            state: absent
          - tasks/check_network_dns.yml

    - name: Stop test if building image or validation is enabled
      meta: end_host
      when: ansible_connection | d("") == "buildah" or __bootc_validation | default(false)

    - name: Test setting auto_gateway to false
      include_tasks: tasks/run_test.yml
      vars:
        lsr_description: Test auto_gateway setting to false
        lsr_setup:
          - what: tasks/manage_test_interface.yml
            state: present
          - tasks/assert_device_present.yml
        lsr_test:
          - network_connections:
              - name: "{{ interface }}"
                type: ethernet
                state: up
                ip:
                  auto_gateway: false
                  dhcp4: false
                  auto6: false
                  address:
                    - "2001:db8::2/64"
                    - "203.0.113.2/24"
                  gateway6: "2001:db8::1"
                  gateway4: "203.0.113.1"
        lsr_assert:
          - tasks/assert_device_present.yml
        lsr_assert_when:
          - what: tasks/assert_profile_present.yml
            profile: "{{ interface }}"
          - what: tasks/assert_command_output.yml
            condition: "{{ __network_is_booted }}"
            lsr_command: ip route
            lsr_not_stdout: default via 203.0.113.1 dev {{ interface }}
          - what: tasks/assert_command_output.yml
            condition: "{{ __network_is_booted and network_provider == 'nm' }}"
            lsr_command: ip -6 route
            lsr_not_stdout: default via 2001:db8::1 dev {{ interface }}
        lsr_cleanup:
          - what: tasks/down_profile+delete_interface.yml
            condition: "{{ __network_is_booted }}"
            profile: "{{ interface }}"
            lsr_persistent_state: absent
          - what: tasks/manage_test_interface.yml
            state: absent
          - tasks/check_network_dns.yml
