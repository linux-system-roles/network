# SPDX-License-Identifier: BSD-3-Clause
---
- name: Play for testing dns support
  hosts: all
  vars:
    type: veth
    interface: ethtest0
  tasks:
    - name: Test dns support
      include_tasks: tasks/run_test.yml
      vars:
        lsr_description: Test dns support
        lsr_setup:
          - what: tasks/manage_test_interface.yml
            state: present
          - tasks/assert_device_present.yml
        lsr_test:
          - network_connections:
              - name: "{{ interface }}"
                interface_name: "{{ interface }}"
                state: up
                type: ethernet
                autoconnect: true
                ip:
                  route_metric4: 100
                  dhcp4: false
                  gateway4: 192.0.2.1
                  dns_priority: 9999
                  dns:
                    - 192.0.2.2
                    - 198.51.100.5
                    - 2001:db8::20
                  dns_search:
                    - example.com
                    - example.org
                  dns_options:
                    - no-aaaa
                    - rotate
                    - timeout:1
                  route_metric6: -1
                  auto6: false
                  gateway6: 2001:db8::1
                  address:
                    - 192.0.2.3/24
                    - 198.51.100.3/26
                    - 2001:db8::80/7
                  route:
                    - network: 198.51.100.128
                      prefix: 26
                      gateway: 198.51.100.1
                      metric: 2
                    - network: 198.51.100.64
                      prefix: 26
                      gateway: 198.51.100.6
                      metric: 4
                  route_append_only: false
                  rule_append_only: true
        lsr_assert:
          - what: tasks/assert_connection_settings.yml
            condition: "{{ network_provider == 'nm' }}"
            lsr_connection_name: "{{ interface }}"
            lsr_connection_settings:
              - section: connection
                option: id
                value: "{{ interface }}"
              - section: connection
                option: interface-name
                value: "{{ interface }}"
              - section: connection
                option: type
                value: ethernet
                nmvalue: 802-3-ethernet
              - section: ipv4
                option: route-metric
                value: "100"
              - section: ipv4
                option: dns
                value: 192.0.2.2;198.51.100.5;
                nmvalue: 192.0.2.2,198.51.100.5
              - section: ipv4
                option: dns-search
                value: example.com;example.org;
                nmvalue: example.com,example.org
              - section: ipv6
                option: dns
                value: 2001:db8::20;
                nmvalue: 2001:db8::20
              - section: ipv6
                option: dns-search
                value: example.com;example.org;
                nmvalue: example.com,example.org
              - section: ipv4
                option: dns-options
                value: no-aaaa;rotate;timeout:1;
                nmvalue: no-aaaa,rotate,timeout:1
              - section: ipv6
                option: dns-options
                value: no-aaaa;rotate;timeout:1;
                nmvalue: no-aaaa,rotate,timeout:1
              - section: ipv4
                option: dns-priority
                value: 9999
              - section: ipv6
                option: dns-priority
                value: 9999
              - section: ipv4
                option: method
                value: manual
              - section: ipv6
                option: method
                value: manual
              - section: ipv4
                option: address1
                value: 192.0.2.3/24
                nmvalue: false
              - section: ipv4
                option: address2
                value: 198.51.100.3/26
                nmvalue: false
              - section: ipv4
                option: addresses
                nmvalue: 192.0.2.3/24, 198.51.100.3/26
              - section: ipv6
                option: address1
                value: 2001:db8::80/7
                nmvalue: false
              - section: ipv6
                option: addresses
                nmvalue: 2001:db8::80/7
              - section: ipv4
                option: gateway
                value: 192.0.2.1
              - section: ipv6
                option: gateway
                value: 2001:db8::1
              - section: ipv4
                option: route1
                value: 198.51.100.128/26,198.51.100.1,2
                nmvalue: false
              - section: ipv4
                option: route2
                value: 198.51.100.64/26,198.51.100.6,4
                nmvalue: false
              - section: ipv4
                option: routes
                nmvalue: 198.51.100.128/26 198.51.100.1 2, 198.51.100.64/26 198.51.100.6 4
        lsr_cleanup:
          - what: tasks/down_profile+delete_interface.yml
            condition: "{{ __network_is_booted }}"
            profile: "{{ interface }}"
            lsr_persistent_state: absent
          - what: tasks/remove_profile.yml
            profile: "{{ interface }}"
          - what: tasks/assert_profile_absent.yml
            condition: "{{ __network_is_booted }}"
            profile: "{{ interface }}"
          - what: tasks/assert_device_absent.yml
            profile: "{{ interface }}"
          - tasks/check_network_dns.yml
