# SPDX-License-Identifier: BSD-3-Clause
---
- name: Play for testing ethtool coalesce settings
  hosts: all
  vars:
    interface: testnic1
    type: veth
  tasks:
    - name: Show playbook name
      debug:
        msg: "this is: playbooks/tests_ethtool_coalesce.yml"
      tags:
        - always

    - name: Include network role vars used by tests
      include_role:
        name: linux-system-roles.network
        tasks_from: set_facts.yml
        public: true

    - name: Run tests
      block:
        - name: Test creating profile without changing ethtool coalesce settings
          when:
            - __network_is_booted
            - not __bootc_validation | d(false)
          include_tasks: tasks/run_test.yml
          vars:
            lsr_description: Test creating profile without changing ethtool coalesce
            lsr_setup:
              - tasks/show_interfaces.yml
              - what: tasks/manage_test_interface.yml
                state: present
              - tasks/assert_device_present.yml
            lsr_test:
              - network_connections:
                  - name: "{{ interface }}"
                    type: ethernet
                    state: up
                    ip:
                      dhcp4: false
                      auto6: false
            lsr_assert:  # NOTE: Cleanup is done in always at very end of file
              - what: tasks/assert_command_output.yml
                condition: "{{ network_provider == 'nm' }}"
                lsr_command: nmcli -g ethtool.coalesce-rx-frames c show {{ interface | quote }}
                lsr_not_stdout: coalesce
              - what: tasks/assert_command_output.yml
                condition: "{{ network_provider == 'initscripts' }}"
                lsr_command: cat /etc/sysconfig/network-scripts/ifcfg-{{ interface | quote }}
                lsr_not_stdout: ETHTOOL
            lsr_cleanup: []

        - name: "TEST: I can set rx-frames."
          include_tasks: tasks/run_test.yml
          vars:
            lsr_description: Test setting coalesce option
            lsr_setup:
              - tasks/show_interfaces.yml
              - what: tasks/manage_test_interface.yml
                state: present
              - tasks/assert_device_present.yml
            lsr_test:
              - network_connections:
                  - name: "{{ interface }}"
                    type: ethernet
                    state: up
                    ip:
                      dhcp4: false
                      auto6: false
                    ethtool:
                      coalesce:
                        rx_frames: 128
            lsr_assert:
              - what: tasks/assert_connection_settings.yml
                condition: "{{ network_provider == 'nm' }}"
                lsr_connection_name: "{{ interface }}"
                lsr_connection_settings:
                  - section: ethtool
                    option: coalesce-rx-frames
                    value: "128"
              - what: tasks/assert_command_output.yml
                condition: "{{ network_provider == 'nm' }}"
                lsr_command: nmcli -g ethtool.coalesce-rx-frames c show {{ interface | quote }}
                lsr_stdout: "128"
              - what: tasks/assert_command_output.yml
                condition: "{{ network_provider == 'initscripts' }}"
                lsr_command: grep ETHTOOL /etc/sysconfig/network-scripts/ifcfg-{{ interface | quote }}
                lsr_stdout: rx-frames 128
            lsr_cleanup: []

        - name: Test clearing ethtool coalesce settings
          when:
            - __network_is_booted
            - not __bootc_validation | d(false)
          include_tasks: tasks/run_test.yml
          vars:
            lsr_description: Test creating profile without changing ethtool features
            lsr_setup:
              - tasks/show_interfaces.yml
              - what: tasks/manage_test_interface.yml
                state: present
              - tasks/assert_device_present.yml
            lsr_test:
              - network_connections:
                  - name: "{{ interface }}"
                    type: ethernet
                    state: up
                    ip:
                      dhcp4: false
                      auto6: false
            lsr_assert:  # NOTE: Cleanup is done in always at very end of file
              - what: tasks/assert_command_output.yml
                condition: "{{ network_provider == 'nm' }}"
                lsr_command: nmcli -g ethtool.coalesce-rx-frames c show {{ interface | quote }}
                lsr_not_stdout: coalesce
              - what: tasks/assert_command_output.yml
                condition: "{{ network_provider == 'initscripts' }}"
                lsr_command: cat /etc/sysconfig/network-scripts/ifcfg-{{ interface | quote }}
                lsr_not_stdout: ETHTOOL
            lsr_cleanup: []

      always:
        - name: Clean up the test device and the connection profile
          when: ansible_connection != "buildah"
          tags:
            - "tests::cleanup"
          block:
            - name: Import network role
              import_role:
                name: linux-system-roles.network
              vars:
                network_connections:
                  - name: "{{ interface }}"
                    persistent_state: absent
              failed_when: false
            - name: Include the task 'manage_test_interface.yml'
              include_tasks: tasks/manage_test_interface.yml
              vars:
                state: absent
            - name: Verify network state restored to default
              include_tasks: tasks/check_network_dns.yml
